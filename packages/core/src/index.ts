import { parse } from "dotenv";
import type { PropertyOptions } from "./validation";
import { validation } from "./validation";

const defaultPrefix = "/* Auto generated by typedotenv */";

export type GenerateOptions = PropertyOptions & {
	/**
	 * Prefix for generated code. [default: `/* Auto generated by typedotenv *â€/`]
	 */
	prefix?: string;
	/**
	 * Object that provide environment variables [default: `process.env`]
	 * @example `import.meta.env`
	 */
	envObject?: string;
	/**
	 * Disable type assertions like `as string`
	 * @example
	 * disableTypeAssertion: true
	 * ```js
	 * export const VAR = process.env.VAR;
	 * ```
	 * disableTypeAssertion: false
	 * ```ts
	 * export const VAR = process.env.VAR as string;
	 * ```
	 */
	disableTypeAssertion?: boolean;
	/**
	 * End of line cheracter [default: `\n`]
	 */
	eol?: string;
};

/**
 * Generate TypeScript from dotenv contents
 * @param dotenv dotenv contents
 * @param options generate options include validation options
 * @returns generated TypeScript code
 */
export const generate = (dotenv: string, options: GenerateOptions = {}) => {
	const parsed = parse(dotenv);
	validation(parsed, options);
	const eol = options.eol ?? "\n";
	const envObject = options.envObject ?? "process.env";
	const typeAssertion = options.disableTypeAssertion ? "" : " as string";
	const definitions = Object.keys(parsed).map(
		(key) => `export const ${key} = ${envObject}.${key}${typeAssertion};`,
	);
	const code = [options.prefix ?? defaultPrefix, ...definitions].join(eol);
	return code + eol;
};
